{% extends 'html/base.html' %}
{% load static %}

{% block title %}Gallery Videos - Admin{% endblock %}

{% block navbar %}
<nav
    class="tw-fixed tw-top-0 tw-left-0 tw-w-full tw-z-50 tw-bg-white/90 tw-backdrop-blur-xl tw-border-b tw-border-slate-100">
    <div class="tw-max-w-7xl tw-mx-auto tw-px-6 tw-h-20 tw-flex tw-items-center tw-justify-between">
        <a href="{% url 'admin_dashboard' %}" class="tw-text-2xl tw-font-black tw-text-slate-900">HealthGate <span
                class="tw-text-blue-600">Admin</span></a>
        <div class="tw-flex tw-gap-8 tw-items-center tw-text-sm tw-font-bold tw-text-slate-600">
            <a href="{% url 'admin_dashboard' %}" class="hover:tw-text-blue-600">Dashboard</a>
            <a href="{% url 'admin_enquiries' %}" class="hover:tw-text-blue-600">Enquiries</a>
            <a href="{% url 'admin_appointments' %}" class="hover:tw-text-blue-600">Appointments</a>

            <div class="tw-relative tw-group">
                <button
                    class="hover:tw-text-blue-600 tw-text-blue-600 tw-flex tw-items-center tw-gap-1.5 tw-transition-colors">
                    Gallery <i
                        class="bi bi-chevron-down tw-text-[10px] tw-transition-transform group-hover:tw-rotate-180"></i>
                </button>
                <div
                    class="tw-absolute tw-top-[calc(100%+0.5rem)] tw-left-0 tw-w-48 tw-bg-white tw-border tw-border-slate-100 tw-rounded-2xl tw-shadow-2xl tw-opacity-0 tw-invisible group-hover:tw-opacity-100 group-hover:tw-visible tw-transition-all tw-duration-300 tw-translate-y-2 group-hover:tw-translate-y-0 tw-z-50 tw-overflow-hidden">
                    <div class="tw-py-2">
                        <a href="{% url 'admin_gallery_photos' %}"
                            class="tw-flex tw-items-center tw-gap-3 tw-px-6 tw-py-3 hover:tw-bg-slate-50 tw-text-slate-600 hover:tw-text-blue-600">
                            <i class="bi bi-images"></i> Photos
                        </a>
                        <a href="{% url 'admin_gallery_videos' %}"
                            class="tw-flex tw-items-center tw-gap-3 tw-px-6 tw-py-3 hover:tw-bg-slate-50 tw-text-slate-600 hover:tw-text-blue-600">
                            <i class="bi bi-play-circle-fill"></i> Videos
                        </a>
                    </div>
                </div>
            </div>
            <a href="{% url 'admin_blogs' %}" class="hover:tw-text-blue-600">Blogs</a>
            <a href="{% url 'home' %}"
                class="tw-bg-slate-100 tw-px-4 tw-py-2 tw-rounded-xl hover:tw-bg-slate-200 tw-transition-all">View
                Site</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block footer %}{% endblock %}

{% block content %}
<div
    class="tw-min-h-screen tw-bg-gradient-to-br tw-from-slate-50 tw-via-blue-50 tw-to-slate-100 tw-pt-32 tw-pb-12 tw-px-[5%]">
    <div class="tw-max-w-7xl tw-mx-auto">
        <!-- Header -->
        <div class="tw-flex tw-items-center tw-justify-between tw-mb-12">
            <div>
                <h1 class="tw-text-5xl tw-font-black tw-text-slate-900">Video <span
                        class="tw-text-blue-600">Vault</span></h1>
                <p class="tw-text-slate-500 tw-mt-2">Managing clinical education and heart care videos.</p>
            </div>
            <button onclick="document.getElementById('add-modal').classList.remove('tw-hidden')"
                class="tw-bg-blue-600 tw-text-white tw-px-8 tw-py-3.5 tw-rounded-2xl tw-font-bold hover:tw-bg-blue-700 tw-transition-all tw-shadow-lg tw-shadow-blue-600/20 tw-flex tw-items-center tw-gap-2">
                <i class="bi bi-plus-lg"></i> Register Video
            </button>
        </div>

        <div class="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 tw-gap-10">
            {% for video in videos %}
            <div
                class="tw-group tw-bg-white tw-rounded-[3rem] tw-shadow-xl tw-border tw-border-slate-100 tw-overflow-hidden tw-relative tw-p-2">
                <div
                    class="tw-aspect-video tw-bg-slate-900 tw-rounded-[2.5rem] tw-overflow-hidden tw-relative tw-flex tw-items-center tw-justify-center">
                    <iframe
                        src="https://www.youtube.com/embed/{{ video.video_id }}?rel=0&modestbranding=1&showinfo=0&iv_load_policy=3"
                        class="tw-w-full tw-h-full" title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
                    </iframe>
                </div>
                <div class="tw-p-8">
                    <div class="tw-flex tw-justify-between tw-items-start tw-gap-4">
                        <div class="tw-flex-1">
                            <div
                                class="tw-mt-4 tw-text-[10px] tw-font-black tw-text-blue-600 tw-bg-blue-50 tw-inline-block tw-px-3 tw-py-1 tw-rounded-full tw-uppercase">
                                ID: {{ video.video_id }}</div>
                        </div>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="item_id" value="{{ video.id }}">
                            <button type="submit"
                                class="tw-w-12 tw-h-12 tw-bg-rose-50 tw-text-rose-600 tw-rounded-2xl tw-flex tw-items-center tw-justify-center hover:tw-bg-rose-600 hover:tw-text-white tw-transition-all"
                                onclick="return confirm('Delete this video from library?')">
                                <i class="bi bi-trash3-fill"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="tw-col-span-full tw-text-center tw-py-20">
                <i class="bi bi-camera-video tw-text-6xl tw-text-slate-300"></i>
                <p class="tw-text-slate-400 tw-mt-4">No videos registered yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Modal -->
<div id="add-modal" class="tw-fixed tw-inset-0 tw-z-[100] tw-hidden tw-flex tw-items-center tw-justify-center tw-p-4">
    <div class="tw-absolute tw-inset-0 tw-bg-slate-900/60 tw-backdrop-blur-sm"
        onclick="this.parentElement.classList.add('tw-hidden')"></div>
    <div
        class="tw-relative tw-w-full tw-max-w-lg tw-bg-white tw-rounded-[3rem] tw-shadow-2xl tw-p-12 tw-max-h-[90vh] tw-overflow-y-auto">
        <h2 class="tw-text-3xl tw-font-black tw-text-slate-900 tw-mb-8">Add <span class="tw-text-blue-600">Video
                Content</span></h2>
        <form method="POST" class="tw-space-y-6" id="video-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            <div>
                <label class="tw-block tw-text-[10px] tw-font-black tw-text-slate-400 tw-uppercase tw-mb-2">YouTube
                    Video URL</label>
                <input type="text" name="video_url" id="video_url_input" required
                    placeholder="Paste YouTube URL (e.g., https://youtu.be/...)"
                    class="tw-w-full tw-bg-slate-50 tw-border tw-border-slate-100 tw-rounded-2xl tw-px-6 tw-py-4 tw-text-sm tw-text-slate-900 focus:tw-bg-white tw-outline-none tw-transition-all focus:tw-ring-4 tw-ring-blue-50"
                    oninput="validateAndPreview()">
                <p id="validation-msg" class="tw-text-xs tw-text-slate-500 tw-mt-2">Waiting for input...</p>
            </div>

            <!-- Preview Section -->
            <div id="video-preview"
                class="tw-hidden tw-mt-6 tw-bg-slate-50 tw-rounded-2xl tw-p-4 tw-border tw-border-slate-100">
                <p class="tw-text-[10px] tw-font-black tw-text-slate-400 tw-uppercase tw-mb-3">Preview</p>
                <div class="tw-aspect-video tw-bg-black tw-rounded-xl tw-overflow-hidden">
                    <iframe id="preview-frame" class="tw-w-full tw-h-full" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>

            <div class="tw-pt-4">
                <button type="submit" id="submit-btn" disabled
                    class="tw-w-full tw-bg-slate-900 tw-text-white tw-py-5 tw-rounded-2xl tw-font-bold hover:tw-bg-black tw-transition-all disabled:tw-opacity-50 disabled:tw-cursor-not-allowed">
                    Register Video
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function validateAndPreview() {
        const input = document.getElementById('video_url_input').value;
        const msg = document.getElementById('validation-msg');
        const preview = document.getElementById('video-preview');
        const frame = document.getElementById('preview-frame');
        const submitBtn = document.getElementById('submit-btn');

        const id = extractYouTubeId(input);

        if (id) {
            msg.textContent = `✅ Valid ID detected: ${id}`;
            msg.className = "tw-text-xs tw-text-green-600 tw-mt-2 tw-font-bold";

            // Update preview
            preview.classList.remove('tw-hidden');
            frame.src = `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1`;

            submitBtn.disabled = false;
            frame.onload = () => {
        msg.textContent = `✅ Video is embeddable`;
        msg.className = "tw-text-xs tw-text-green-600 tw-mt-2 tw-font-bold";
        submitBtn.disabled = false;
    };

    frame.onerror = () => {
        msg.textContent = `❌ Embedding disabled by video owner`;
        msg.className = "tw-text-xs tw-text-red-600 tw-mt-2 tw-font-bold";
        submitBtn.disabled = true;
        frame.src = "";
        preview.classList.add('tw-hidden');
    };
        } else {
            if (input.length > 0) {
                msg.textContent = "❌ Invalid YouTube URL";
                msg.className = "tw-text-xs tw-text-red-500 tw-mt-2";
            } else {
                msg.textContent = "Paste any YouTube URL - thumbnail will be auto-generated";
                msg.className = "tw-text-xs tw-text-slate-500 tw-mt-2";
            }
            preview.classList.add('tw-hidden');
            frame.src = "";
            submitBtn.disabled = true;
        }
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        if (/^[a-zA-Z0-9_-]{11}$/.test(url.trim())) return url.trim();

        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/shorts\/|youtube\.com\/v\/|youtube\.com\/\?v=)([a-zA-Z0-9_-]{11})/,
            /youtube\.com\/.*[?&]v=([a-zA-Z0-9_-]{11})/
        ];

        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) return match[1];
        }
        return null;
    }
</script>
{% endblock %}